---
- name: Web Server Setup
  hosts: webserver
  become: true
 
  tasks:
    - name: Install Web Server Components
      apt:
        name: "{{item}}"
        state: present
        update_cache: yes
      with_items:
        - apache2
        - libapache2-mod-wsgi
        - python-pip
        - python-virtualenv

    - name: Verfiy that Apache2 Server is Running
      service:
        name: apache2
        state: started
        enabled: yes

    - name: Ensure Mode WSGI enabled
      apache2_module:
        state: present
        name: wsgi
      notify:
        restart apache2  
   
    - name: Copy demo app source
      copy:
        src: ~vagrant/work/ansible-practice/demo/app/
        dest: /var/www/demo
        mode: 0755
      notify: restart apache2
    
    - name: Copy apache virtual host config
      copy: 
        src: ~vagrant/work/ansible-practice/demo/demo.conf
        dest: /etc/apache2/sites-available
        mode: 0755
      notify: restart apache2
 
    - name: Setup python virtualenv
      pip:
        requirements: /var/www/demo/requirements.txt
        virtualenv: /var/www/demo/.venv
      notify: restart apache2   

    - name: De-activate Default Apache Site
      file:
        path: /etc/apache2/sites-enabled/000-default.conf
        state: absent
      notify: restart apache2

    - name: activate demo apache site
      file:
        src: /etc/apache2/sites-available/demo.conf
        dest: /etc/apache2/sites-enabled/demo.conf
        state: link
      notify: restart apache2


  handlers:
    - name: restart apache2
      service:
        name: apache2
        state: restarted
